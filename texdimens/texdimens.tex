% This is file texdimens.tex, part of texdimens package, which
% is distributed under the LPPL 1.3c. Copyright (c) 2021 Jean-FranÃ§ois B.
% 2021/07/10 v0.9gamma
\edef\texdimensendinput{\endlinechar\the\endlinechar\catcode`\noexpand _=\the\catcode`\_\relax\noexpand\endinput}%
\endlinechar13\relax%
\catcode`\_=11
% Is T sp attainable from unit "uu"?. Here we suppose T>0.
% phi>1, psi=1/phi, psi<1
% U(N,phi)=floor(N phi) is strictly increasing
%     U(N)<= T <  U(N+1)    iff    N = ceil((T+1)psi) - 1
%     U(M)<  T <= U(M+1)    iff    M = ceil(T psi)    - 1
% Either:
% -  M = N, i.e. T is not attainable, M=N < T psi < (T+1) psi <= N+1
% -  M = N - 1, i.e. T is attained, T psi <= N < (T+1) psi, T = floor(N phi) 
%
% In the latter case:
% - as psi<1, |N - (T+0.5) psi| < 0.5, hence N = R := round((T+0.5) psi).
%   Also works for T=0 but T<0 would need -0.5.
%
% - if psi<1/2, then N = round(T psi) is simpler formula which works
%   also for attainable T<0.
%
% This R=round((T+0.5) psi) can always be computed via \numexpr because 2T+1
% will not trigger arithmetic overflow.
%
% If Tsp>0 is not attainable, this R can produce either N or N+1 (=M+1).
%
% If we try computing ceil(x) via round(x+0.5) (\numexpr rounds up)
% this means for N, we need round((T+1)psi + 0.5), for example with
% psi = 100/7227 for "in", this gives round((((T+1)200)+7227)/14454)
% feasible via \numexpr only for (circa) 100 T less than \maxdimen.
%
% We could rather compute round(T psi) but we don't know if it gives
% N or N+1. We know it is N if round(T psi)< round((T+1) psi)
% but if the two are the same we don't know if they are both N or
% both N+1.
%
% It is slightly less costly to compute X = round(T psi) than R,
% but if we then realize that trunc(X phi) < T  we do not yet know
% if trunc((X+1) phi) = T  or is > T, except if psi<1/2, because
% if T sp is attainable then X = round(T psi) is then necessarily N
% so if trunc(X phi) < T we now that T sp was not attainable.
%
% For psi>1/2, i.e. bp, nd, dd, we will go via R, not X:
%
% 1. compute R = round((T+0.5) psi) in \numexpr. This forces
%    to check for negative T because then we would want here (T-0.5)psi
%
% 2. check for the "up" and "down" variants whether trunc(R phi)
%    <, =, or > T (this will go via D uu where D is a decimal obtained
%    from \the\dimexpr R sp)
%    But we have to choose here what "up" and "down" mean for T<0.
%    Also, computation of D uu
%    may trigger Dimension too large if T sp is not attainable,
%    close to \maxdimen, and \maxdimen itself is not attainable.
%
% For the envisioned "safe versions" we would tabulate first per unit
% what is the integer Rmax such that trunc(Rmax phi) <= \maxdimen.
% Then the "safe" versions
% would have an extra check of R. But for \texdimeninuuu it will
% then not be compliant to its definition for inputs close to
% non-attainable \maxdimen.
%
% After having written the macros we will tabulate what is for each unit
% the maximal attainable dimension.
%
% There was some hesitation about whether or not using the simpler
% round(T psi) approach for units > 2pt and the \texdimin<uu>
% macros.
%
% Testing showed that this did not change the output for \maxdimen
% with the units "nc" and "in": still N+1 is returned...
%
% As it has great
% advantage to not have to check the sign of the input, the
% "simpler" approach was chosen for those units to which it
% applies, i.e. the units uu > 2pt (phi>2, psi<1/2), i.e.
% all units except bp, nd and dd.
%
\def\texdiminpt#1{\expandafter\texdiminpt_\the\dimexpr#1\relax}%
{\catcode`p 12\catcode`t 12\csname expandafter\endcsname\gdef\csname texdiminpt_\endcsname#1pt{#1}}%
% bp 7227/7200 = 803/800
% complications and annoying overhead caused by sign
% and we don't want to evaluate #1 twice in a \dimexpr; if #1 was
% restricted to be a dimen register, we would avoid "\the and re-grab" step.
\def\texdiminbp#1{\expandafter\texdiminbp_\the\numexpr\dimexpr#1;}%
\def\texdiminbp_#1#2;{\texdiminpt{\numexpr(2*#1#2+\if-#1-\fi1)*400/803sp}}%
% nd 685/642
\def\texdiminnd#1{\expandafter\texdiminnd_\the\numexpr\dimexpr#1;}%
\def\texdiminnd_#1#2;{\texdiminpt{\numexpr(2*#1#2+\if-#1-\fi1)*321/685sp}}%
% dd 1238/1157
\def\texdimindd#1{\expandafter\texdimindd_\the\numexpr\dimexpr#1;}%
\def\texdimindd_#1#2;{\texdiminpt{\numexpr(2*#1#2+\if-#1-\fi1)*1157/2476sp}}%
% mm 7227/2540 phi now >2, use from here on the simpler approach
\def\texdiminmm#1{\expandafter\texdiminpt_\the\dimexpr(#1)*2540/7227\relax}%
% \texdiminmmdown: maximal dim exactly expressible in mm and at most equal to input
\def\texdiminmmdown#1{\expandafter\texdiminmmd_a\the\numexpr\dimexpr#1;}%
\def\texdiminmmd_a#1{\if-#1\texdiminmmd_neg\fi\texdiminmmd_b#1}%
\def\texdiminmmd_b#1;{\expandafter\texdiminmmd_c\the\numexpr#1*2540/7227;#1;}%
\def\texdiminmmd_c#1;{\expandafter\texdiminmmd_d\the\dimexpr#1sp;#1;}%
{\catcode`P 12\catcode`T 12\lowercase{\gdef\texdiminmmd_d#1PT};#2;#3;%
   {\ifdim#1mm>#3sp \texdiminmmd_e{#2}\fi\texdimfirstofone{#1}}%
}%
\def\texdimfirstofone#1{#1}%
\def\texdiminmmd_e#1#2#3#4{#2\expandafter\texdiminpt_\the\dimexpr\numexpr(#1-1)sp\relax}%
% The problem here is that if close to 0sp, output can be 0, and we do not want
% -0 as output. So let's do this somewhat brutally. Anyhow, negative inputs are
% not our priority
\def\texdiminmmd_neg#1#2-#3;{\expandafter\texdiminpt_\the\dimexpr-\texdiminmmd_b#3;pt\relax}%
% pc 12/1
\def\texdiminpc#1{\expandafter\texdiminpt_\the\dimexpr(#1)/12\relax}%
% nc 1370/107
\def\texdiminnc#1{\expandafter\texdiminpt_\the\dimexpr(#1)*107/1370\relax}%
% cc 14856/1157
\def\texdimincc#1{\expandafter\texdiminpt_\the\dimexpr(#1)*1157/14856\relax}%
% cm 7227/254
\def\texdimincm#1{\expandafter\texdiminpt_\the\dimexpr(#1)*254/7227\relax}%
% in 7227/100
\def\texdiminin#1{\expandafter\texdiminpt_\the\dimexpr(#1)*100/7227\relax}%
\texdimensendinput
%! Local variables:
%! mode: TeX
%! fill-column: 1000
%! End:
